const adminIllustrationsModel = require("../model/adminIllustrationsModel");

// ‚úÖ Lister toutes les illustrations (admin)
const browse = async (req, res) => {
	try {
		console.info("üîç [ADMIN ILLUSTRATIONS] D√©but de browse");
		console.info("üîç [ADMIN ILLUSTRATIONS] Query params:", req.query);

		const { limit, offset } = req.query;
		console.info("üîç [ADMIN ILLUSTRATIONS] Limit:", limit, "Offset:", offset);

		console.info("üîç [ADMIN ILLUSTRATIONS] Appel findAll...");
		const illustrations = await adminIllustrationsModel.findAll(limit, offset);
		console.info(
			"üîç [ADMIN ILLUSTRATIONS] Illustrations trouv√©es:",
			illustrations.length,
		);
		console.info(
			"üîç [ADMIN ILLUSTRATIONS] Premi√®re illustration:",
			illustrations[0],
		);

		console.info("üîç [ADMIN ILLUSTRATIONS] Appel countAll...");
		const totalCount = await adminIllustrationsModel.countAll();
		console.info("üîç [ADMIN ILLUSTRATIONS] Total count:", totalCount);

		const totalPages = Math.ceil(totalCount / limit);
		console.info("üîç [ADMIN ILLUSTRATIONS] Total pages:", totalPages);

		const response = {
			illustrations,
			pagination: {
				limit,
				offset,
				totalCount,
				totalPages,
			},
		};

		console.info(
			"üîç [ADMIN ILLUSTRATIONS] R√©ponse finale:",
			JSON.stringify(response, null, 2),
		);
		res.success(response);
	} catch (error) {
		console.error("‚ùå [ADMIN ILLUSTRATIONS] Erreur browse:", error);
		res.error("Erreur lors de la r√©cup√©ration des illustrations", 500);
	}
};

// ‚úÖ R√©cup√©rer une illustration par ID (admin)
const read = async (req, res) => {
	try {
		const { id } = req.params;
		const illustration = await adminIllustrationsModel.findById(id);

		if (!illustration) {
			return res.error("Illustration non trouv√©e", 404);
		}

		res.success({ illustration });
	} catch (error) {
		console.error("Erreur read admin illustration:", error);
		res.error("Erreur lors de la r√©cup√©ration de l'illustration", 500);
	}
};

// ‚úÖ Cr√©er une nouvelle illustration
const create = async (req, res) => {
	try {
		const { title, description, image, alt_text, is_in_gallery, tagIds } =
			req.body;

		const newIllustration = await adminIllustrationsModel.create({
			title,
			description,
			image,
			alt_text,
			is_in_gallery,
			tagIds: tagIds || [],
		});

		res.success(
			{ illustration: newIllustration },
			"Illustration cr√©√©e avec succ√®s",
		);
	} catch (error) {
		console.error("Erreur create illustration:", error);
		res.error("Erreur lors de la cr√©ation de l'illustration", 500);
	}
};

// ‚úÖ Modifier une illustration
const update = async (req, res) => {
	try {
		const { id } = req.params;
		const { title, description, image, alt_text, is_in_gallery, tagIds } =
			req.body;

		const updatedIllustration = await adminIllustrationsModel.update(id, {
			title,
			description,
			image,
			alt_text,
			is_in_gallery,
			tagIds: tagIds || [],
		});

		res.success(
			{ illustration: updatedIllustration },
			"Illustration modifi√©e avec succ√®s",
		);
	} catch (error) {
		console.error("Erreur update illustration:", error);

		if (error.message === "Illustration non trouv√©e") {
			return res.error("Illustration non trouv√©e", 404);
		}

		res.error("Erreur lors de la modification de l'illustration", 500);
	}
};

// ‚úÖ Supprimer une illustration
const remove = async (req, res) => {
	try {
		const { id } = req.params;

		const deletedIllustration = await adminIllustrationsModel.remove(id);

		res.success(
			{ illustration: deletedIllustration },
			"Illustration supprim√©e avec succ√®s",
		);
	} catch (error) {
		console.error("Erreur delete illustration:", error);

		if (error.message === "Illustration non trouv√©e") {
			return res.error("Illustration non trouv√©e", 404);
		}

		res.error("Erreur lors de la suppression de l'illustration", 500);
	}
};

// ‚úÖ R√©cup√©rer tous les tags disponibles
const getTags = async (req, res) => {
	try {
		const tags = await adminIllustrationsModel.getAllTags();
		res.success({ tags });
	} catch (error) {
		console.error("Erreur get tags:", error);
		res.error("Erreur lors de la r√©cup√©ration des tags", 500);
	}
};

module.exports = {
	browse,
	read,
	create,
	update,
	remove,
	getTags,
};
